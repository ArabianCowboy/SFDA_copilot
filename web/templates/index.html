<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="SFDA Copilot - AI-powered regulatory guidance for pharmaceutical regulations in Saudi Arabia">
    <title>SFDA Copilot</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script>
        function loadScript(src, onload) {
            const script = document.createElement('script');
            script.src = src;
            script.onload = onload;
            document.body.appendChild(script);
        }
        window.SUPABASE_URL = JSON.parse('{{ SUPABASE_URL | tojson | safe }}');
        window.SUPABASE_ANON_KEY = JSON.parse('{{ SUPABASE_ANON_KEY | tojson | safe }}');
    </script>
</head>
<body class="d-flex flex-column min-vh-100">
    <!-- Auth Modal -->
    <div class="modal fade" id="authModal" tabindex="-1" aria-labelledby="authModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h2 class="modal-title h5" id="authModalLabel">Login / Signup</h2>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-0">
                    <ul class="nav nav-tabs nav-fill" id="authTab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active py-3" id="login-tab" data-bs-toggle="tab" data-bs-target="#login-pane" type="button" role="tab" aria-controls="login-pane" aria-selected="true">
                                <i class="bi bi-box-arrow-in-right me-2"></i>Login
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link py-3" id="signup-tab" data-bs-toggle="tab" data-bs-target="#signup-pane" type="button" role="tab" aria-controls="signup-pane" aria-selected="false">
                                <i class="bi bi-person-plus me-2"></i>Signup
                            </button>
                        </li>
                    </ul>
                    <div class="tab-content p-4" id="authTabContent">
                        <div class="tab-pane fade show active" id="login-pane" role="tabpanel" aria-labelledby="login-tab">
                            <form id="login-form" novalidate>
                                <div class="form-floating mb-3">
                                    <input type="email" class="form-control" id="login-email" placeholder=" " required aria-invalid="false">
                                    <label for="login-email"><i class="bi bi-envelope me-2"></i>Email address</label>
                                    <div class="invalid-feedback">Please provide a valid email.</div>
                                </div>
                                <div class="form-floating mb-4">
                                    <input type="password" class="form-control" id="login-password" placeholder=" " required aria-invalid="false" autocomplete="current-password">
                                    <label for="login-password"><i class="bi bi-lock me-2"></i>Password</label>
                                    <div class="invalid-feedback">Password is required.</div>
                                </div>
                                <button type="submit" class="btn btn-primary w-100 btn-lg py-2 fw-bold">
                                    <span class="spinner-border spinner-border-sm d-none me-2" role="status" aria-hidden="true"></span>
                                    Login
                                </button>
                            </form>
                        </div>
                        <div class="tab-pane fade" id="signup-pane" role="tabpanel" aria-labelledby="signup-tab">
                            <form id="signup-form" novalidate>
                                <div class="form-floating mb-3">
                                    <input type="email" class="form-control" id="signup-email" placeholder=" " required aria-invalid="false">
                                    <label for="signup-email"><i class="bi bi-envelope me-2"></i>Email address</label>
                                    <div class="invalid-feedback">Please provide a valid email.</div>
                                </div>
                                <div class="form-floating mb-4">
                                    <input type="password" class="form-control" id="signup-password" placeholder=" " required pattern="(?=.*\d)(?=.*[a-z])(?=.*[A-Z]).{8,}" aria-invalid="false" autocomplete="new-password">
                                    <label for="signup-password"><i class="bi bi-lock me-2"></i>Password</label>
                                    <div class="form-text mt-1">
                                        Min. 8 characters, 1 uppercase, 1 lowercase, 1 number.
                                    </div>
                                    <div class="invalid-feedback">
                                        Password must meet the requirements.
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-success w-100 btn-lg py-2 fw-bold">
                                    <span class="spinner-border spinner-border-sm d-none me-2" role="status" aria-hidden="true"></span>
                                    Signup
                                </button>
                            </form>
                        </div>
                    </div>
                    <div id="auth-error" class="alert alert-danger mx-3 mb-3 d-none" role="alert"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile Header -->
    <nav class="navbar navbar-dark bg-dark d-lg-none sticky-top">
        <div class="container-fluid">
            <button class="navbar-toggler" type="button" data-bs-toggle="offcanvas" data-bs-target="#sidebarOffcanvas" aria-controls="sidebarOffcanvas" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <span class="navbar-brand mb-0 h1">SFDA Copilot</span>
        </div>
    </nav>

    <main class="container-fluid flex-grow-1">
        <div class="row h-100">
            <!-- Sidebar -->
            <aside class="col-lg-3 col-md-4 sidebar d-none d-lg-block h-100" id="sidebarContentRegular">
                <div class="sidebar-header">
                    <h3 class="d-flex align-items-center"><i class="bi bi-shield-shaded me-2"></i>SFDA Copilot</h3>
                    <p class="text-muted small mb-3">Your AI Regulatory Assistant</p>
                    <div class="auth-status-container mt-2">
                        <span id="user-status" class="small">Checking status...</span>
                        <button id="auth-button" class="btn btn-sm btn-outline-light ms-2" type="button">Login / Signup</button>
                        <button id="logout-button" class="btn btn-sm btn-outline-warning ms-2 d-none" type="button">Logout</button>
                    </div>
                </div>
                <div class="faq-section">
                    <h4 class="ps-2"><i class="bi bi-journal-text"></i>Regulatory FAQs</h4>
                    <nav class="nav nav-pills flex-column" aria-label="Regulatory FAQs">
                        <button class="nav-link faq-button" role="tab" data-category="regulatory" data-question="What are the requirements for drug registration in Saudi Arabia?">Drug Registration</button>
                        <button class="nav-link faq-button" role="tab" data-category="regulatory" data-question="How to submit variations for approved drugs?">Variation Submission</button>
                        <button class="nav-link faq-button" role="tab" data-category="regulatory" data-question="What are the GMP requirements for manufacturing sites?">GMP Requirements</button>
                        <button class="nav-link faq-button" role="tab" data-category="regulatory" data-question="What is the process for clinical trial approval?">Clinical Trial Approval</button>
                        <button class="nav-link faq-button" role="tab" data-category="regulatory" data-question="What are the labeling requirements for pharmaceutical products?">Labeling Requirements</button>
                    </nav>
                    <h4 class="ps-2 mt-3"><i class="bi bi-shield-check"></i>Pharmacovigilance FAQs</h4>
                    <nav class="nav nav-pills flex-column" aria-label="Pharmacovigilance FAQs">
                        <button class="nav-link faq-button" role="tab" data-category="pharmacovigilance" data-question="What are the adverse event reporting requirements in Saudi Arabia?">Adverse Event Reporting</button>
                        <button class="nav-link faq-button" role="tab" data-category="pharmacovigilance" data-question="What is the role of a QPPV in Saudi Arabia?">QPPV Role</button>
                        <button class="nav-link faq-button" role="tab" data-category="pharmacovigilance" data-question="What should be included in a Periodic Safety Update Report (PSUR)?">PSUR Requirements</button>
                        <button class="nav-link faq-button" role="tab" data-category="pharmacovigilance" data-question="Could you provide a table outlining the reporting time frames for submitting Individual Case Safety Reports (ICSRs)?">Reporting Timeline</button>
                        <button class="nav-link faq-button" role="tab" data-category="pharmacovigilance" data-question="What are the requirements for a Risk Management Plan?">Risk Management Plan</button>
                    </nav>
                </div>
            </aside>

            <!-- Offcanvas Sidebar -->
            <div class="offcanvas offcanvas-start bg-dark text-white d-lg-none" tabindex="-1" id="sidebarOffcanvas" aria-labelledby="sidebarOffcanvasLabel">
                <div class="offcanvas-header">
                    <h5 class="offcanvas-title" id="sidebarOffcanvasLabel">Menu</h5>
                    <button type="button" class="btn-close btn-close-white text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
                </div>
                <div class="offcanvas-body sidebar">
                    <div class="sidebar-header">
                        <h3 class="d-flex align-items-center"><i class="bi bi-shield-shaded me-2"></i>SFDA Copilot</h3>
                        <p class="text-muted small mb-3">Your AI Regulatory Assistant</p>
                        <div class="auth-status-container mt-2">
                            <span id="user-status-offcanvas" class="small">Checking status...</span>
                            <button id="auth-button-offcanvas" class="btn btn-sm btn-outline-light ms-2" type="button">Login / Signup</button>
                            <button id="logout-button-offcanvas" class="btn btn-sm btn-outline-warning ms-2 d-none" type="button">Logout</button>
                        </div>
                    </div>
                    <div class="faq-section">
                        <h4 class="ps-2"><i class="bi bi-journal-text"></i>Regulatory FAQs</h4>
                        <nav class="nav nav-pills flex-column" aria-label="Regulatory FAQs">
                            <button class="nav-link faq-button" role="tab" data-category="regulatory" data-question="What are the requirements for drug registration in Saudi Arabia?">Drug Registration</button>
                            <button class="nav-link faq-button" role="tab" data-category="regulatory" data-question="How to submit variations for approved drugs?">Variation Submission</button>
                            <button class="nav-link faq-button" role="tab" data-category="regulatory" data-question="What are the GMP requirements for manufacturing sites?">GMP Requirements</button>
                            <button class="nav-link faq-button" role="tab" data-category="regulatory" data-question="What is the process for clinical trial approval?">Clinical Trial Approval</button>
                            <button class="nav-link faq-button" role="tab" data-category="regulatory" data-question="What are the labeling requirements for pharmaceutical products?">Labeling Requirements</button>
                        </nav>
                        <h4 class="ps-2 mt-3"><i class="bi bi-shield-check"></i>Pharmacovigilance FAQs</h4>
                        <nav class="nav nav-pills flex-column" aria-label="Pharmacovigilance FAQs">
                            <button class="nav-link faq-button" role="tab" data-category="pharmacovigilance" data-question="What are the adverse event reporting requirements in Saudi Arabia?">Adverse Event Reporting</button>
                            <button class="nav-link faq-button" role="tab" data-category="pharmacovigilance" data-question="What is the role of a QPPV in Saudi Arabia?">QPPV Role</button>
                            <button class="nav-link faq-button" role="tab" data-category="pharmacovigilance" data-question="What should be included in a Periodic Safety Update Report (PSUR)?">PSUR Requirements</button>
                            <button class="nav-link faq-button" role="tab" data-category="pharmacovigilance" data-question="What is the timeline for reporting serious adverse events to SFDA?">Reporting Timeline</button>
                            <button class="nav-link faq-button" role="tab" data-category="pharmacovigilance" data-question="What are the requirements for a Risk Management Plan?">Risk Management Plan</button>
                        </nav>
                    </div>
                </div>
            </div>

            <!-- Main chat area -->
            <section class="col-12 col-lg-9 chat-area h-100 d-flex flex-column">
                <div class="chat-container">
                    <div id="messages" class="messages" aria-live="polite">
                        <div class="message chatbot-message animated-message mb-3 message-medium">
                            <div class="message-bubble">
                                <div class="avatar mb-2">
                                    <img src="{{ url_for('static', filename='images/bot.jpg') }}" alt="bot avatar" class="rounded-circle" loading="lazy" width="40" height="40">
                                </div>
                                <div class="message-content">
                                    <p>
                                        Welcome to SFDA Copilot! Your AI assistant for pharmaceutical regulations in Saudi Arabia. You can:
                                    </p>
                                    <ul class="message-list">
                                        <li><i class="bi bi-question-circle me-2 text-primary"></i>Ask me specific questions about regulatory requirements</li>
                                        <li><i class="bi bi-filter-circle me-2 text-success"></i>Select a category to focus your search</li>
                                        <li><i class="bi bi-hand-index-thumb me-2 text-info"></i>Click on FAQ buttons for common questions</li>
                                    </ul>
                                    <p>
                                        How can I assist you today?
                                    </p>
                                </div>
                                <div class="timestamp">{{ now }}</div>
                            </div>
                        </div>
                    </div>
                    <div class="input-area">
                        <div class="category-selector mb-2">
                            <label for="query-category">Search in:</label>
                            <select id="query-category" class="form-select">
                                <option value="all" selected>All Categories</option>
                                <option value="regulatory">Regulatory</option>
                                <option value="pharmacovigilance">Pharmacovigilance</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <input type="text" id="query-input" class="form-control"
                                   placeholder="Ask about SFDA regulations..."
                                   aria-label="Chat message input"
                                   aria-describedby="inputHelp"
                                   maxlength="500">
                            <button class="btn btn-primary" type="button" id="send-button"
                                    aria-label="Send message">
                                <i class="bi bi-send"></i> Send
                            </button>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </main>
    <div id="toast" class="toast-notification hidden" role="alert" aria-live="assertive">
        Error message goes here
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/date-fns-setup.js') }}"></script>
    <script type="module" src="{{ url_for('static', filename='js/app.js') }}"></script>
</body>
</html>
